<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LJ Services Group - Ticket Management System</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="animated-menu.css">
    <link rel="stylesheet" href="quick-fixes.css">

    <!-- ‚úÖ Dropbox Chooser/Saver API (replace YOUR_DROPBOX_APP_KEY) -->
    <script
        type="text/javascript"
        src="https://www.dropbox.com/static/api/2/dropins.js"
        id="dropboxjs"
        data-app-key="gazrj3d6rgyf6eb">
        <script src="animated-menu.js"></script>
    </script>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="screen active">
        <div class="login-container">
            <div class="logo-section">
                <h1>LJ Services Group</h1>
                <p>Property Management Ticket System</p>
            </div>

            <!-- ‚úÖ Login buttons block (Microsoft + Dropbox + Demo) -->
            <div class="login-buttons">
                <!-- Existing Microsoft login button -->
                <button id="loginButton" class="microsoft-login">
                    <svg width="21" height="21" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="10" height="10" fill="#f25022"/>
                        <rect x="11" width="10" height="10" fill="#00a4ef"/>
                        <rect y="11" width="10" height="10" fill="#7fba00"/>
                        <rect x="11" y="11" width="10" height="10" fill="#ffb900"/>
                    </svg>
                    Sign in with Microsoft
                </button>

                <!-- ‚úÖ New: Connect Dropbox Storage button -->
                <button id="dropboxLoginBtn" class="dropbox-login">
                    üìÅ Connect Dropbox Storage
                </button>

                <div class="divider">or</div>

                <!-- ‚úÖ New: Demo mode button -->
                <button id="demoLoginBtn" class="demo-login">
                    üöÄ Try Demo Mode
                </button>
            </div>

            <p class="login-note">
                Dropbox integration securely saves all tickets (5TB storage, auto-sync, shared between Linda & Kevin).
            </p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboardScreen" class="screen">
        <nav class="navbar">
            <div class="nav-left">
                <h2>LJ Services Ticket System</h2>
            </div>
            <div class="nav-right">
                <span id="userEmail" class="user-email"></span>
                <button id="logoutButton" class="btn-secondary">Logout</button>
            </div>
        </nav>

        <div class="container">
            <div class="dashboard-header">
                <h1 id="dashboardTitle">Ticket Dashboard</h1>
                <div class="header-actions">
                    <button id="switchToViolationsBtn" class="btn-warning">üö® Violations</button>
                    <button id="switchToWhatsAppBtn" class="btn-secondary">üì± WhatsApp</button>
                    <button id="switchToTicketsBtn" class="btn-secondary" style="display:none;">üìã Tickets</button>
                    <button id="createTicketBtn" class="btn-primary">+ Create New Ticket</button>
                    <button id="createViolationBtn" class="btn-danger" style="display:none;">+ New Violation</button>
                </div>
            </div>

            <!-- ‚úÖ New: Dropbox actions toolbar -->
            <div class="dropbox-actions">
                <button id="syncDropboxBtn" class="btn-secondary">
                    üîÑ Sync with Dropbox
                </button>
                <span id="syncStatus" class="sync-status">‚úì Synced</span>

                <button id="exportBtn" class="btn-secondary">
                    üìä Export to Excel
                </button>

                <button id="viewDropboxBtn" class="btn-secondary">
                    üìÅ View in Dropbox
                </button>
            </div>

            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="openTickets">0</div>
                    <div class="stat-label">Open Tickets</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="inProgressTickets">0</div>
                    <div class="stat-label">In Progress</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedTickets">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTickets">0</div>
                    <div class="stat-label">Total Tickets</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <select id="statusFilter" class="filter-select">
                    <option value="">All Statuses</option>
                    <option value="open">Open</option>
                    <option value="in-progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="closed">Closed</option>
                </select>
                <select id="associationFilter" class="filter-select">
                    <option value="">All Associations</option>
                </select>
                <select id="priorityFilter" class="filter-select">
                    <option value="">All Priorities</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                </select>
                <input type="text" id="searchInput" class="search-input" placeholder="Search tickets...">
            </div>

            <!-- Tickets List -->
            <div id="manualTicketsSection" class="tickets-section active">
                <h2 class="section-title">Manual Tickets</h2>
                <div id="ticketsList" class="tickets-list">
                    <!-- Tickets will be dynamically loaded here -->
                </div>
            </div>

            <!-- WhatsApp Tickets Section -->
            <div id="whatsappTicketsSection" class="tickets-section">
                <h2 class="section-title">WhatsApp Bot Tickets</h2>
                <div class="whatsapp-info-banner">
                    <p>üì± <strong>WhatsApp Bot Status:</strong> <span id="botStatus" class="status-badge">Not Configured</span></p>
                    <button id="setupWhatsAppBtn" class="btn-primary">Setup WhatsApp Bot</button>
                </div>
                <div id="whatsappTicketsList" class="tickets-list">
                    <!-- WhatsApp tickets will be dynamically loaded here -->
                </div>
            </div>

            <!-- Violations Management Section -->
            <div id="violationsSection" class="tickets-section">
                <div class="violations-header">
                    <h2 class="section-title">Violations Management</h2>
                    <div class="violations-actions">
                        <button id="manageRulesBtn" class="btn-secondary">üìã Manage Rules</button>
                        <button id="cincSyncBtn" class="btn-secondary">üîÑ Sync CINC Data</button>
                    </div>
                </div>

                <!-- Violations Stats -->
                <div class="violations-stats">
                    <div class="violation-stat-card warning">
                        <div class="stat-icon">üìÑ</div>
                        <div class="stat-content">
                            <div class="stat-number" id="firstNoticeCount">0</div>
                            <div class="stat-label">1st Notices</div>
                        </div>
                    </div>
                    <div class="violation-stat-card alert">
                        <div class="stat-icon">‚ö†Ô∏è</div>
                        <div class="stat-content">
                            <div class="stat-number" id="secondNoticeCount">0</div>
                            <div class="stat-label">2nd Notices</div>
                        </div>
                    </div>
                    <div class="violation-stat-card danger">
                        <div class="stat-icon">üî¥</div>
                        <div class="stat-content">
                            <div class="stat-number" id="thirdNoticeCount">0</div>
                            <div class="stat-label">3rd Notices</div>
                        </div>
                    </div>
                    <div class="violation-stat-card resolved">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-content">
                            <div class="stat-number" id="resolvedViolationsCount">0</div>
                            <div class="stat-label">Resolved</div>
                        </div>
                    </div>
                </div>

                <!-- Violations Filters -->
                <div class="filters">
                    <select id="violationStatusFilter" class="filter-select">
                        <option value="">All Statuses</option>
                        <option value="1st-notice">1st Notice</option>
                        <option value="2nd-notice">2nd Notice</option>
                        <option value="3rd-notice">3rd Notice (Hearing)</option>
                        <option value="resolved">Resolved</option>
                    </select>
                    <select id="violationAssociationFilter" class="filter-select">
                        <option value="">All Associations</option>
                    </select>
                    <select id="violationCategoryFilter" class="filter-select">
                        <option value="">All Categories</option>
                    </select>
                    <input type="text" id="violationSearchInput" class="search-input" placeholder="Search violations...">
                </div>

                <!-- Violations List -->
                <div id="violationsList" class="violations-list">
                    <!-- Violations will be dynamically loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Ticket Modal -->
    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Create New Ticket</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="ticketForm">
                <div class="form-group">
                    <label for="ticketTitle">Title *</label>
                    <input type="text" id="ticketTitle" required>
                </div>

                <div class="form-group">
                    <label for="ticketAssociation">Association *</label>
                    <select id="ticketAssociation" required>
                        <option value="">Select Association</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="ticketPriority">Priority *</label>
                        <select id="ticketPriority" required>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="ticketAssignedTo">Assign To</label>
                        <select id="ticketAssignedTo">
                            <option value="">Unassigned</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="ticketDescription">Description *</label>
                    <textarea id="ticketDescription" rows="5" required></textarea>
                </div>

                <div class="form-group">
                    <label for="ticketDueDate">Due Date</label>
                    <input type="date" id="ticketDueDate">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary cancel-btn">Cancel</button>
                    <button type="submit" class="btn-primary">Create Ticket</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ticket Detail Modal -->
    <div id="ticketDetailModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="detailTicketTitle"></h2>
                <button class="close-detail-modal">&times;</button>
            </div>
            <div class="ticket-detail-content">
                <div class="detail-left">
                    <div class="detail-section">
                        <h3>Description</h3>
                        <p id="detailDescription"></p>
                    </div>

                    <div class="detail-section">
                        <h3>Updates & Comments</h3>
                        <div id="ticketUpdates" class="updates-list">
                            <!-- Updates will be loaded here -->
                        </div>
                        <div class="add-update">
                            <textarea id="newUpdate" placeholder="Add an update or comment..." rows="3"></textarea>
                            <button id="addUpdateBtn" class="btn-primary">Add Update</button>
                        </div>
                    </div>
                </div>

                <div class="detail-right">
                    <div class="detail-info">
                        <div class="info-item">
                            <label>Status</label>
                            <select id="detailStatus" class="status-select">
                                <option value="open">Open</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                        <div class="info-item">
                            <label>Priority</label>
                            <span id="detailPriority" class="priority-badge"></span>
                        </div>
                        <div class="info-item">
                            <label>Association</label>
                            <span id="detailAssociation"></span>
                        </div>
                        <div class="info-item">
                            <label>Assigned To</label>
                            <select id="detailAssignedTo" class="assign-select">
                                <option value="">Unassigned</option>
                            </select>
                        </div>
                        <div class="info-item">
                            <label>Created By</label>
                            <span id="detailCreatedBy"></span>
                        </div>
                        <div class="info-item">
                            <label>Created Date</label>
                            <span id="detailCreatedDate"></span>
                        </div>
                        <div class="info-item">
                            <label>Due Date</label>
                            <span id="detailDueDate"></span>
                        </div>
                        <div class="info-item">
                            <label>Ticket ID</label>
                            <span id="detailTicketId"></span>
                        </div>
                    </div>

                    <div class="detail-actions">
                        <button id="sendEmailBtn" class="btn-secondary">üìß Send Email Update</button>
                        <button id="deleteTicketBtn" class="btn-danger">Delete Ticket</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Violation Modal -->
    <div id="violationModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="violationModalTitle">Create New Violation</h2>
                <button class="close-violation-modal">&times;</button>
            </div>
            <form id="violationForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="violationHomeowner">Homeowner Name *</label>
                        <input type="text" id="violationHomeowner" required>
                    </div>
                    <div class="form-group">
                        <label for="violationUnit">Unit/Address *</label>
                        <input type="text" id="violationUnit" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="violationEmail">Email Address *</label>
                        <input type="email" id="violationEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="violationPhone">Phone Number</label>
                        <input type="tel" id="violationPhone">
                    </div>
                </div>

                <div class="form-group">
                    <label for="violationAssociation">Association *</label>
                    <select id="violationAssociation" required>
                        <option value="">Select Association</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="violationCategory">Violation Category *</label>
                    <select id="violationCategory" required>
                        <option value="">Select Category</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="violationRules">Select Violated Rules *</label>
                    <select id="violationRules" multiple size="5" required>
                        <option value="">Loading rules...</option>
                    </select>
                    <small>Hold Ctrl (Cmd on Mac) to select multiple rules</small>
                </div>

                <div class="form-group">
                    <label for="violationDescription">Detailed Description *</label>
                    <textarea id="violationDescription" rows="5" required placeholder="Describe the violation in detail..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="violationDate">Date Observed *</label>
                        <input type="date" id="violationDate" required>
                    </div>
                    <div class="form-group">
                        <label for="violationNoticeLevel">Notice Level *</label>
                        <select id="violationNoticeLevel" required>
                            <option value="1st-notice">1st Notice (Warning)</option>
                            <option value="2nd-notice">2nd Notice (Second Warning)</option>
                            <option value="3rd-notice">3rd Notice (Hearing Letter)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="violationDeadline">Compliance Deadline *</label>
                    <input type="date" id="violationDeadline" required>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary cancel-violation-btn">Cancel</button>
                    <button type="submit" class="btn-danger">Create Violation & Generate PDF</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Rules Management Modal -->
    <div id="rulesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manage Violation Rules</h2>
                <button class="close-rules-modal">&times;</button>
            </div>
            <div class="rules-content">
                <div class="rules-header">
                    <button id="addRuleBtn" class="btn-primary">+ Add New Rule</button>
                </div>

                <div class="rules-categories">
                    <div class="category-section">
                        <h3>Categories</h3>
                        <div id="categoriesList" class="categories-list">
                            <!-- Categories will load here -->
                        </div>
                        <button id="addCategoryBtn" class="btn-secondary btn-small">+ Add Category</button>
                    </div>

                    <div class="rules-section">
                        <h3>Rules</h3>
                        <div id="rulesList" class="rules-list-container">
                            <!-- Rules will load here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CINC Sync Modal -->
    <div id="cincSyncModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>CINC Data Synchronization</h2>
                <button class="close-cinc-modal">&times;</button>
            </div>
            <div class="cinc-sync-content">
                <div class="sync-info">
                    <p>üìä <strong>CINC Integration Status:</strong> <span id="cincStatus" class="status-badge">Not Connected</span></p>
                    <p>Last sync: <span id="lastSyncTime">Never</span></p>
                </div>

                <div class="sync-options">
                    <h3>Sync Options</h3>
                    
                    <div class="form-group">
                        <label for="cincApiUrl">CINC API URL</label>
                        <input type="url" id="cincApiUrl" placeholder="https://api.cincsystems.com">
                    </div>

                    <div class="form-group">
                        <label for="cincApiKey">API Key</label>
                        <input type="password" id="cincApiKey" placeholder="Enter your CINC API key">
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="autoSync">
                            Auto-sync homeowner data daily
                        </label>
                    </div>

                    <div class="sync-actions">
                        <button id="testCincConnection" class="btn-secondary">Test Connection</button>
                        <button id="syncNowBtn" class="btn-primary">Sync Now</button>
                        <button id="saveCincSettings" class="btn-success">Save Settings</button>
                    </div>
                </div>

                <div class="sync-log">
                    <h3>Sync Log</h3>
                    <div id="syncLogContent" class="log-content">
                        No sync history yet.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="violations.js"></script>
    <script src="app.js"></script>
</body>
</html>
